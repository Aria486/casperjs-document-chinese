## casper模块

### casper类
获取casper实例最简单的方法是使用模块的`create()`方法：
```js
var casper = require('casper').create();
```

您也可以自己检索主要功能并实例化：
```js
var casper = new require('casper').Casper();
```

> 提示
在这里了解[如何扩展Casper](http://docs.casperjs.org/en/latest/extending.html)。

Casper构造器和`create()`函数都接受一个标准的js对象作为选项参数：
```js
var casper = require('casper').create({
    verbose: true,
    logLevel: "debug"
});
```

### casper.options
选项对象可以被传递到Casper构造器中：
```js
var casper = require('casper').create({
    clientScripts:  [
        'includes/jquery.js',      // These two scripts will be injected in remote
        'includes/underscore.js'   // DOM on every request
    ],
    pageSettings: {
        loadImages:  false,        // The WebPage instance used by Casper will
        loadPlugins: false         // use these settings
    },
    logLevel: "info",              // Only "info" level messages will be logged
    verbose: true                  // log messages will be printed out to the console
});
```

您还可以在运行时更改选项:
```js
var casper = require('casper').create();
casper.options.waitTimeout = 1000;
```

下面是所有选项的详细信息：

#### clientScripts
**类型**：Array

**默认值**：[ ]

包含在加载的每个页面中脚本文件路径的集合。

#### exitOnError
**类型**：Boolean

**默认值**：true

设置当脚本抛出未捕获的错误时CasperJS是否必须退出。

#### httpStatusHandlers
**类型**：Object

**默认值**：{ }

设置当脚本抛出未捕获的错误时CasperJS是否必须退出。

#### logLevel
**类型**：string

**默认值**："error"

设置log等级。

#### onAlert
**类型**：Function

**默认值**：null

**调用方式** ：onAlert(Object Casper,String message)

当JavaScript alert()函数执行时调用的函数。

#### onDie
**类型**：Function

**默认值**：null

**调用方式** ：onDie(Object Casper,String message,String status)

当Casper#die()函数执行时调用的函数。

#### onError
**类型**：Function

**默认值**：null

**调用方式** ：onError(Object Casper,String msg,Array backtrace)

发生“错误”级别事件时调用的函数。

#### onLoadError
**类型**：Function

**默认值**：null

**调用方式** ：onLoadError(Object Casper,String requestUrl,String status)

当请求的资源不能被加载时调用的函数。

#### onPageInitialized
**类型**：Function

**默认值**：null

**调用方式** ：onPageInitialized(Object page)

WebPage实例初始化后调用的函数。

#### onResourceReceived
**类型**：Function

**默认值**：null

**调用方式** ：onResourceReceived(Object Casper, Object resource)

PhantomJS'WebPage＃onResourceReceived（）回调的代理方法，但当前的Casper实例作为第一个参数传递。

#### onResourceRequested
**类型**：Function

**默认值**：null

**调用方式** ：onResourceRequested(Object Casper, Object resource)

PhantomJS的WebPage代理方法＃onResourceRequested（）回调，但当前的Casper实例作为第一个参数传递。

#### onStepComplete
**类型**：Function

**默认值**：null

**调用方式** ：onStepComplete(Object Casper, stepResult)

当step函数执行完毕后执行的函数。

#### onStepTimeout
**类型**：Function

**默认值**：Function

**调用方式** ：onStepTimeout(Integer timeout, Integer stepNum)

当step函数执行时间超过stepTimeout选项的值（如果已设置）时执行的函数。
默认情况下，在超时时，脚本将退出显示错误，而在测试环境中，只会将错误添加到套件结果中。

#### onTimeout
**类型**：Function

**默认值**： Function

**调用方式** ：onTimeout(Integer timeout)

当脚本执行时间超过超时选项的值时执行的功能（如果有的话）。
默认情况下，在超时时，脚本将退出显示错误，而在测试环境中，只会将错误添加到套件结果中。

#### onWaitTimeout
**类型**：Function

**默认值**：Function

**调用方式** ：onWaitTimeout(Integer timeout)

当waitFor *函数执行时间超过waitTimeout选项的值（如果有）已被设置时执行的函数 。
默认情况下，在超时时，脚本将退出显示错误，而在测试环境中，只会将错误添加到套件结果中。

#### page
**类型**：WebPage

**默认值**：null

一个PhanthomJS网页实例。

> 警告
修改`page`的属性可能会导致一些Casper的特性无法工作。比如，修改`onUrlChanged`属性会导致`waitForUrl`特性无法工作。

#### pageSettings
**类型**： Object

**默认值**：{ }

PhantomJS的WebPage选项对象。可用的设置有：
- `javascriptEnabled`定义是否在页面中执行脚本（默认为true）
- `loadImages`定义是否加载内联图像
- `localToRemoteUrlAccessEnabled`定义本地资源（例如从文件）是否可以访问远程URL（默认为false）
- `userAgent`定义当网页请求资源时发送到服务器的用户代理
- `userName`设置用于HTTP认证的用户名
- `password`设置用于HTTP认证的密码
- `resourceTimeout`（以毫秒为单位）定义超时时间，所请求的资源将停止尝试并继续执行页面的其他部分。`onResourceTimeout`回调将在超时时被调用。`undefined`（默认值）表示默认gecko参数。

PhantomJS具体设置：
- `XSSAuditingEnabled`定义是否应监视跨站点脚本尝试的加载请求（默认为false）
- `webSecurityEnabled`定义是否应启用Web安全性（默认为true）

SlimerJS具体设置 :
- `allowMedia false`可以取消加载媒体（音频/视频）。默认值：true。 （仅限SlimerJS）
- `maxAuthAttempts`指示HTTP身份验证的最大尝试次数。 （SlimerJS 0.9）
- `plainTextAllContent true`表示`pages.plainText`返回所有内容，甚至脚本元素的内容，不可见元素等。默认值：false。

#### remoteScripts
**类型**： Array

**默认值**：[ ]

*版本1.0新增*

包含在加载的每个页面中远程脚本URL的集合。

#### safeLogs
**类型**： Boolean

**默认值**：true

*版本1.0新增*

当此选项设置为true时，默认情况下，在`<input type =“password”>`中输入的任何密码信息将在日志消息中被模糊化。将safeLog设置为false将以透明文本披露密码（不推荐）。

#### SilentErrors
**类型**： Boolean

**默认值**：false

启用此选项时，不会抛出捕获的步骤错误（尽管相关事件仍然发生）。在测试环境中大部分内部使用。

#### stepTimeout
**类型**： Number

**默认值**：null

`Max step timeout`的单位为毫秒，当设置时，每个定义的step函数都将在达到此超时值之前执行。

您可以定义`onStepTimeout( )`回调来捕获这种情况。默认情况下，脚本将会`die( )`并显示错误消息。

#### timeout
**类型**： Number

**默认值**：null

最大超时数（毫秒）。

#### verbose
**类型**： Boolean

**默认值**：false

实时输出`log`消息。


#### viewportSize
**类型**： Object

**默认值**：null

视口大小，例如{width：800，height：600}。

> 提示
PhantomJS附带的默认视口为400x300，CasperJS默认不会覆盖它。

#### retryTimeout
**类型**： Number

**默认值**：100

尝试之间的默认延迟，是与wait系函数配套的函数。

#### waitTimeout
**类型**： Number

**默认值**：100

默认等待超时的时间，是与wait系函数配套的函数。

### Casper 原型
#### back( )
**调用方式**：back( )

返回浏览器历史的上一页面。
```js
casper.start('http://foo.bar/1')
casper.thenOpen('http://foo.bar/2');
casper.thenOpen('http://foo.bar/3');
casper.back();
casper.run(function() {
    console.log(this.getCurrentUrl()); // 'http://foo.bar/2'
});
```
建议你一起看看[forward()](http://docs.casperjs.org/en/latest/modules/casper.html#forward)函数。

#### base64encode()
**调用方式**：base64encode(String url \[, String method, Object data\])

使用客户端XMLHttpRequest同步使用base64算法对资源进行编码。

>提示
我们不能使用window.btoa( )，因为它在PhantomJS使用的WebKit版本中不能运行。

示例：检索base64编码的Google logo 图像
```js
var base64logo = null;
casper.start('http://www.google.fr/', function() {
    base64logo = this.base64encode('http://www.google.fr/images/srpr/logo3w.png');
});

casper.run(function() {
    this.echo(base64logo).exit();
});
```

您还可以执行HTTP POST请求来检索要编码的内容:
```js
var base64contents = null;
casper.start('http://domain.tld/download.html', function() {
    base64contents = this.base64encode('http://domain.tld/', 'POST', {
        param1: 'foo',
        param2: 'bar'
    });
});

casper.run(function() {
    this.echo(base64contents).exit();
});
```

#### bypass( )
**调用方式**：bypass(Numbr nb)

*1.1版本新增*
绕过一定数量的导航步骤：
```js
casper.start();
casper.then(function() {
    // This step will be executed
});
casper.then(function() {
    this.bypass(2);
});
casper.then(function() {
    // This test won't be executed
});
casper.then(function() {
    // Nor this one
});
casper.run();
```

#### click( )
**调用方法**：click(String selector, \[Number|String X, Number|String Y\])

点击由选择器表达式匹配出来的元素，该方法依次尝试两种策略：
1. 使用JavaScript触发点击事件。
2. 如果第一种尝试失败，则使用原生QtWebKit事件。

例如：
```js
casper.start('http://google.fr/');

casper.thenEvaluate(function(term) {
    document.querySelector('input[name="q"]').setAttribute('value', term);
    document.querySelector('form[name="f"]').submit();
}, 'CasperJS');

casper.then(function() {
    // Click on 1st result link
    this.click('h3.r a');
});

casper.then(function() {
    // Click on 1st result link
    this.click('h3.r a',10,10);
});

casper.then(function() {
    // Click on 1st result link
    this.click('h3.r a',"50%","50%");
});


casper.then(function() {
    console.log('clicked ok, new location is ' + this.getCurrentUrl());
});

casper.run();
```

#### clickLabel( )
**调用方法**： clickLabel(String label\[, String tag\])

*0.6.1版本新增*

找到包含标签文本的第一个DOM元素，并确保元素节点名称是标签（可选）：
```js
// <a href="...">My link is beautiful</a>
casper.then(function() {
    this.clickLabel('My link is beautiful', 'a');
});

// <button type="submit">But my button is sexier</button>
casper.then(function() {
    this.clickLabel('But my button is sexier', 'button');
});
```

#### capture( )
**调用方法** : capture(String targetFilepath, \[Object clipRect, Object imgOptions\])

PhantomJS的WebPage＃render的代理方法，添加一个截屏参数，用于自动设置页面截屏设置，并在完成后将其还原：
```js
casper.start('http://www.google.fr/', function() {
    this.capture('google.png', {
        top: 100,
        left: 100,
        width: 500,
        height: 400
    });
});

casper.run();
```

*版本1.1新增*

imgOptions对象允许指定两个选项:
- `format`可以手动设置图像格式，避免依赖文件名。
- `quality`可以设置图像质量，数值从1到100。

示例：
```js
casper.start('http://foo', function() {
    this.capture('foo', undefined, {
        format: 'jpg',
        quality: 75
    });
});
```

#### captureBase64()
**调用方式**：captureBase64(String format\[, Mixed area\])

以给定的格式计算当前页面或页面内的区域的二进制图像捕获的Base64表示.

支持的图像格式有：bmp,jpg,jpeg,png,ppm,tiff,xbm,xpm。

`area`参数可以是以下几种类型：
- String：一个CSS3选择器字符串，比如：`div#plop form[name="form"] input[type="submit"]`。
- cilpRect: 一个cilpRect对象，比如：`{"top":0,"left":0,"width":320,"height":200}`
- Object: 一个选择器对象，比如：一个XPath选择器。

例子：
```js
casper.start('http://google.com', function() {
    // selector capture
    console.log(this.captureBase64('png', '#lga'));
    // clipRect capture
    console.log(this.captureBase64('png', {
        top: 0,
        left: 0,
        width: 320,
        height: 200
    }));
    // whole page capture
    console.log(this.captureBase64('png'));
});

casper.run();
```

#### captureSelector()
**调用方法**： captureSelector(String targetFile, String selector \[, Object imgOptions\])

捕获包含提供的选择器的页面区域并将其保存到`targetFile`：
```js
casper.start('http://www.weather.com/', function() {
    this.captureSelector('weather.png', '#LookingAhead');
});

casper.run();
```

*版本1.1新增*

`imgOptions`对象允许指定两个选项：
- `format`允许指定保存文件的格式，而不依赖于文件名。
- `quality`可以设置图像质量，数值从1到100。

#### clear( )
**调用方法**：clear( )

*版本0.6.5新增*
清除当前页面执行环境上下文，避免先前加载的DOM内容仍然活动。

它是在远程DOM环境中阻止JavaScript执行的一种方法：
```js
casper.start('http://www.google.fr/', function() {
    this.clear(); // 本页面的JavaScript将停止执行
});

casper.then(function() {
    // ...
});

casper.run();
```

#### clearCache()
**调用方法**：clearCache( )

*版本1.1.5新增*

用newPage()将新页面对象替换为当前页面，并使用clearMemoryCache()清除内存缓存。例子：
```js
casper.start('http://www.google.fr/', function() {
    this.clearCache(); // cleared the memory cache and replaced page object with newPage().
});

casper.then(function() {
    // ...
});

casper.run();
```

#### clearMemoryCache()
**调用方法**： clearMemoryCache()

*版本1.1.5新增*

使用引擎的`page.clearMemoryCache()`方法来清除内存缓存。例子：
```js
casper.start('http://www.google.fr/', function() {
    this.clearMemoryCache(); // cleared the memory cache.
});

casper.then(function() {
    // ...
});

casper.run();
```

#### debugHTML()
**调用方法**：debugHTML(\[String selector, Boolean outer\])

在控制台直接输出`getHTML()`的结果，它的参数与`getHTML()`相同。

#### debugPage()
**调用方法**：debugPage()

将当前页面的文本内容直接记录到标准输出，以进行调试：
```js
casper.start('http://www.google.fr/', function() {
    this.debugPage();
});

casper.run();
```
